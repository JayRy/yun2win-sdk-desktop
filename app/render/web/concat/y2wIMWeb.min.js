
function config(){}function nop(){}function guid(){var e=function(){return(0|65536*(1+Math.random())).toString(16).substring(1)};return e()+e()+"-"+e()+"-"+e()+"-"+e()+"-"+e()+e()+e()}function baseRequest(){}function transTextToBytes(e){for(var t=new ArrayBuffer(e.length),s=new Uint8Array(t,0),n=0;e.length>n;n++)s[n]=255&e.charCodeAt(n);return s}function transBase64ToBytes(e){for(var t=e.indexOf(";base64,"),s=window.atob(e.substring(t+8)),n=new Uint8Array(s.length),r=0;s.length>r;r++)n[r]=s.charCodeAt(r);return n}function y2wAuthorizeRequest(){}function swap(e,t,s){var n=e[t];e[t]=e[s],e[s]=n}function partition(e,t,s,n,r){for(var i=e[Math.floor((n+s)/2)],a=s,o=n;o>=a;){if(r){for(;e[a][t]>i[t];)a++;for(;e[o][t]<i[t];)o--}else{for(;e[a][t]<i[t];)a++;for(;e[o][t]>i[t];)o--}o>=a&&(swap(e,a,o),a++,o--)}return a}function quickSortAlgo(e,t,s,n,r){var i;return e.length>1&&(i=partition(e,t,s,n,r),i-1>s&&quickSortAlgo(e,t,s,i-1,r),n>i&&quickSortAlgo(e,t,i,n,r)),e}function quickSort(e,t,s){return quickSortAlgo(e,t,0,e.length-1,s)}(function(){function e(e){var s=!1;return function(){if(s)throw Error("Callback was already called.");s=!0,e.apply(t,arguments)}}var t,s,n={};t=this,null!=t&&(s=t.async),n.noConflict=function(){return t.async=s,n};var r=Object.prototype.toString,i=Array.isArray||function(e){return"[object Array]"===r.call(e)},a=function(e,t){for(var s=0;e.length>s;s+=1)t(e[s],s,e)},o=function(e,t){if(e.map)return e.map(t);var s=[];return a(e,function(e,n,r){s.push(t(e,n,r))}),s},u=function(e,t,s){return e.reduce?e.reduce(t,s):(a(e,function(e,n,r){s=t(s,e,n,r)}),s)},c=function(e){if(Object.keys)return Object.keys(e);var t=[];for(var s in e)e.hasOwnProperty(s)&&t.push(s);return t};"undefined"!=typeof process&&process.nextTick?(n.nextTick=process.nextTick,n.setImmediate="undefined"!=typeof setImmediate?function(e){setImmediate(e)}:n.nextTick):"function"==typeof setImmediate?(n.nextTick=function(e){setImmediate(e)},n.setImmediate=n.nextTick):(n.nextTick=function(e){setTimeout(e,0)},n.setImmediate=n.nextTick),n.each=function(t,s,n){function r(e){e?(n(e),n=function(){}):(i+=1,i>=t.length&&n())}if(n=n||function(){},!t.length)return n();var i=0;a(t,function(t){s(t,e(r))})},n.forEach=n.each,n.eachSeries=function(e,t,s){if(s=s||function(){},!e.length)return s();var n=0,r=function(){t(e[n],function(t){t?(s(t),s=function(){}):(n+=1,n>=e.length?s():r())})};r()},n.forEachSeries=n.eachSeries,n.eachLimit=function(e,t,s,n){var r=l(t);r.apply(null,[e,s,n])},n.forEachLimit=n.eachLimit;var l=function(e){return function(t,s,n){if(n=n||function(){},!t.length||0>=e)return n();var r=0,i=0,a=0;(function o(){if(r>=t.length)return n();for(;e>a&&t.length>i;)i+=1,a+=1,s(t[i-1],function(e){e?(n(e),n=function(){}):(r+=1,a-=1,r>=t.length?n():o())})})()}},d=function(e){return function(){var t=Array.prototype.slice.call(arguments);return e.apply(null,[n.each].concat(t))}},h=function(e,t){return function(){var s=Array.prototype.slice.call(arguments);return t.apply(null,[l(e)].concat(s))}},p=function(e){return function(){var t=Array.prototype.slice.call(arguments);return e.apply(null,[n.eachSeries].concat(t))}},f=function(e,t,s,n){if(t=o(t,function(e,t){return{index:t,value:e}}),n){var r=[];e(t,function(e,t){s(e.value,function(s,n){r[e.index]=n,t(s)})},function(e){n(e,r)})}else e(t,function(e,t){s(e.value,function(e){t(e)})})};n.map=d(f),n.mapSeries=p(f),n.mapLimit=function(e,t,s,n){return g(t)(e,s,n)};var g=function(e){return h(e,f)};n.reduce=function(e,t,s,r){n.eachSeries(e,function(e,n){s(t,e,function(e,s){t=s,n(e)})},function(e){r(e,t)})},n.inject=n.reduce,n.foldl=n.reduce,n.reduceRight=function(e,t,s,r){var i=o(e,function(e){return e}).reverse();n.reduce(i,t,s,r)},n.foldr=n.reduceRight;var m=function(e,t,s,n){var r=[];t=o(t,function(e,t){return{index:t,value:e}}),e(t,function(e,t){s(e.value,function(s){s&&r.push(e),t()})},function(){n(o(r.sort(function(e,t){return e.index-t.index}),function(e){return e.value}))})};n.filter=d(m),n.filterSeries=p(m),n.select=n.filter,n.selectSeries=n.filterSeries;var v=function(e,t,s,n){var r=[];t=o(t,function(e,t){return{index:t,value:e}}),e(t,function(e,t){s(e.value,function(s){s||r.push(e),t()})},function(){n(o(r.sort(function(e,t){return e.index-t.index}),function(e){return e.value}))})};n.reject=d(v),n.rejectSeries=p(v);var y=function(e,t,s,n){e(t,function(e,t){s(e,function(s){s?(n(e),n=function(){}):t()})},function(){n()})};n.detect=d(y),n.detectSeries=p(y),n.some=function(e,t,s){n.each(e,function(e,n){t(e,function(e){e&&(s(!0),s=function(){}),n()})},function(){s(!1)})},n.any=n.some,n.every=function(e,t,s){n.each(e,function(e,n){t(e,function(e){e||(s(!1),s=function(){}),n()})},function(){s(!0)})},n.all=n.every,n.sortBy=function(e,t,s){n.map(e,function(e,s){t(e,function(t,n){t?s(t):s(null,{value:e,criteria:n})})},function(e,t){if(e)return s(e);var n=function(e,t){var s=e.criteria,n=t.criteria;return n>s?-1:s>n?1:0};s(null,o(t.sort(n),function(e){return e.value}))})},n.auto=function(e,t){t=t||function(){};var s=c(e),r=s.length;if(!r)return t();var o={},l=[],d=function(e){l.unshift(e)},h=function(e){for(var t=0;l.length>t;t+=1)if(l[t]===e)return l.splice(t,1),void 0},p=function(){r--,a(l.slice(0),function(e){e()})};d(function(){if(!r){var e=t;t=function(){},e(null,o)}}),a(s,function(s){var r=i(e[s])?e[s]:[e[s]],l=function(e){var r=Array.prototype.slice.call(arguments,1);if(1>=r.length&&(r=r[0]),e){var i={};a(c(o),function(e){i[e]=o[e]}),i[s]=r,t(e,i),t=function(){}}else o[s]=r,n.setImmediate(p)},f=r.slice(0,Math.abs(r.length-1))||[],g=function(){return u(f,function(e,t){return e&&o.hasOwnProperty(t)},!0)&&!o.hasOwnProperty(s)};if(g())r[r.length-1](l,o);else{var m=function(){g()&&(h(m),r[r.length-1](l,o))};d(m)}})},n.retry=function(e,t,s){var r=5,i=[];"function"==typeof e&&(s=t,t=e,e=r),e=parseInt(e,10)||r;var a=function(r,a){for(var o=function(e,t){return function(s){e(function(e,n){s(!e||t,{err:e,result:n})},a)}};e;)i.push(o(t,!(e-=1)));n.series(i,function(e,t){t=t[t.length-1],(r||s)(t.err,t.result)})};return s?a():a},n.waterfall=function(e,t){if(t=t||function(){},!i(e)){var s=Error("First argument to waterfall must be an array of functions");return t(s)}if(!e.length)return t();var r=function(e){return function(s){if(s)t.apply(null,arguments),t=function(){};else{var i=Array.prototype.slice.call(arguments,1),a=e.next();a?i.push(r(a)):i.push(t),n.setImmediate(function(){e.apply(null,i)})}}};r(n.iterator(e))()};var A=function(e,t,s){if(s=s||function(){},i(t))e.map(t,function(e,t){e&&e(function(e){var s=Array.prototype.slice.call(arguments,1);1>=s.length&&(s=s[0]),t.call(null,e,s)})},s);else{var n={};e.each(c(t),function(e,s){t[e](function(t){var r=Array.prototype.slice.call(arguments,1);1>=r.length&&(r=r[0]),n[e]=r,s(t)})},function(e){s(e,n)})}};n.parallel=function(e,t){A({map:n.map,each:n.each},e,t)},n.parallelLimit=function(e,t,s){A({map:g(t),each:l(t)},e,s)},n.series=function(e,t){if(t=t||function(){},i(e))n.mapSeries(e,function(e,t){e&&e(function(e){var s=Array.prototype.slice.call(arguments,1);1>=s.length&&(s=s[0]),t.call(null,e,s)})},t);else{var s={};n.eachSeries(c(e),function(t,n){e[t](function(e){var r=Array.prototype.slice.call(arguments,1);1>=r.length&&(r=r[0]),s[t]=r,n(e)})},function(e){t(e,s)})}},n.iterator=function(e){var t=function(s){var n=function(){return e.length&&e[s].apply(null,arguments),n.next()};return n.next=function(){return e.length-1>s?t(s+1):null},n};return t(0)},n.apply=function(e){var t=Array.prototype.slice.call(arguments,1);return function(){return e.apply(null,t.concat(Array.prototype.slice.call(arguments)))}};var U=function(e,t,s,n){var r=[];e(t,function(e,t){s(e,function(e,s){r=r.concat(s||[]),t(e)})},function(e){n(e,r)})};n.concat=d(U),n.concatSeries=p(U),n.whilst=function(e,t,s){e()?t(function(r){return r?s(r):(n.whilst(e,t,s),void 0)}):s()},n.doWhilst=function(e,t,s){e(function(r){if(r)return s(r);var i=Array.prototype.slice.call(arguments,1);t.apply(null,i)?n.doWhilst(e,t,s):s()})},n.until=function(e,t,s){e()?s():t(function(r){return r?s(r):(n.until(e,t,s),void 0)})},n.doUntil=function(e,t,s){e(function(r){if(r)return s(r);var i=Array.prototype.slice.call(arguments,1);t.apply(null,i)?s():n.doUntil(e,t,s)})},n.queue=function(t,s){function r(e,t,s,r){return e.started||(e.started=!0),i(t)||(t=[t]),0==t.length?n.setImmediate(function(){e.drain&&e.drain()}):(a(t,function(t){var i={data:t,callback:"function"==typeof r?r:null};s?e.tasks.unshift(i):e.tasks.push(i),e.saturated&&e.tasks.length===e.concurrency&&e.saturated(),n.setImmediate(e.process)}),void 0)}void 0===s&&(s=1);var o=0,u={tasks:[],concurrency:s,saturated:null,empty:null,drain:null,started:!1,paused:!1,push:function(e,t){r(u,e,!1,t)},kill:function(){u.drain=null,u.tasks=[]},unshift:function(e,t){r(u,e,!0,t)},process:function(){if(!u.paused&&u.concurrency>o&&u.tasks.length){var s=u.tasks.shift();u.empty&&0===u.tasks.length&&u.empty(),o+=1;var n=function(){o-=1,s.callback&&s.callback.apply(s,arguments),u.drain&&0===u.tasks.length+o&&u.drain(),u.process()},r=e(n);t(s.data,r)}},length:function(){return u.tasks.length},running:function(){return o},idle:function(){return 0===u.tasks.length+o},pause:function(){u.paused!==!0&&(u.paused=!0)},resume:function(){if(u.paused!==!1){u.paused=!1;for(var e=1;u.concurrency>=e;e++)n.setImmediate(u.process)}}};return u},n.priorityQueue=function(e,t){function s(e,t){return e.priority-t.priority}function r(e,t,s){for(var n=-1,r=e.length-1;r>n;){var i=n+(r-n+1>>>1);s(t,e[i])>=0?n=i:r=i-1}return n}function o(e,t,o,u){return e.started||(e.started=!0),i(t)||(t=[t]),0==t.length?n.setImmediate(function(){e.drain&&e.drain()}):(a(t,function(t){var i={data:t,priority:o,callback:"function"==typeof u?u:null};e.tasks.splice(r(e.tasks,i,s)+1,0,i),e.saturated&&e.tasks.length===e.concurrency&&e.saturated(),n.setImmediate(e.process)}),void 0)}var u=n.queue(e,t);return u.push=function(e,t,s){o(u,e,t,s)},delete u.unshift,u},n.cargo=function(e,t){var s=!1,r=[],u={tasks:r,payload:t,saturated:null,empty:null,drain:null,drained:!0,push:function(e,s){i(e)||(e=[e]),a(e,function(e){r.push({data:e,callback:"function"==typeof s?s:null}),u.drained=!1,u.saturated&&r.length===t&&u.saturated()}),n.setImmediate(u.process)},process:function c(){if(!s){if(0===r.length)return u.drain&&!u.drained&&u.drain(),u.drained=!0,void 0;var n="number"==typeof t?r.splice(0,t):r.splice(0,r.length),i=o(n,function(e){return e.data});u.empty&&u.empty(),s=!0,e(i,function(){s=!1;var e=arguments;a(n,function(t){t.callback&&t.callback.apply(null,e)}),c()})}},length:function(){return r.length},running:function(){return s}};return u};var S=function(e){return function(t){var s=Array.prototype.slice.call(arguments,1);t.apply(null,s.concat([function(t){var s=Array.prototype.slice.call(arguments,1);"undefined"!=typeof console&&(t?console.error&&console.error(t):console[e]&&a(s,function(t){console[e](t)}))}]))}};n.log=S("log"),n.dir=S("dir"),n.memoize=function(e,t){var s={},r={};t=t||function(e){return e};var i=function(){var i=Array.prototype.slice.call(arguments),a=i.pop(),o=t.apply(null,i);o in s?n.nextTick(function(){a.apply(null,s[o])}):o in r?r[o].push(a):(r[o]=[a],e.apply(null,i.concat([function(){s[o]=arguments;var e=r[o];delete r[o];for(var t=0,n=e.length;n>t;t++)e[t].apply(null,arguments)}])))};return i.memo=s,i.unmemoized=e,i},n.unmemoize=function(e){return function(){return(e.unmemoized||e).apply(null,arguments)}},n.times=function(e,t,s){for(var r=[],i=0;e>i;i++)r.push(i);return n.map(r,t,s)},n.timesSeries=function(e,t,s){for(var r=[],i=0;e>i;i++)r.push(i);return n.mapSeries(r,t,s)},n.seq=function(){var e=arguments;return function(){var t=this,s=Array.prototype.slice.call(arguments),r=s.pop();n.reduce(e,s,function(e,s,n){s.apply(t,e.concat([function(){var e=arguments[0],t=Array.prototype.slice.call(arguments,1);n(e,t)}]))},function(e,s){r.apply(t,[e].concat(s))})}},n.compose=function(){return n.seq.apply(null,Array.prototype.reverse.call(arguments))};var M=function(e,t){var s=function(){var s=this,n=Array.prototype.slice.call(arguments),r=n.pop();return e(t,function(e,t){e.apply(s,n.concat([t]))},r)};if(arguments.length>2){var n=Array.prototype.slice.call(arguments,2);return s.apply(this,n)}return s};n.applyEach=d(M),n.applyEachSeries=p(M),n.forever=function(e,t){function s(n){if(n){if(t)return t(n);throw n}e(s)}s()},"undefined"!=typeof module&&module.exports?module.exports=n:"undefined"!=typeof define&&define.amd?define([],function(){return n}):t.async=n})();var avatarRandomBGColorCount=5,defaultContactImageUrl="images/contact_avatar.png",defaultGroupImageUrl="images/group_avatar.png",addEvent=function(e,t,s){window.addEventListener?e.addEventListener(t,s,!1):e.attachEvent("on"+t,s)},transTime=function(){var e=function(e){e.setMinutes(0),e.setSeconds(0),e.setMilliseconds(0),e.setHours(0);var t=e.getTime();e.setMonth(1),e.setDate(1);var s=e.getTime();return[t,s]};return function(t){var s=e(new Date);return t>=s[0]?dateFormat(t,"HH:mm"):s[0]>t&&t>=s[1]?dateFormat(t,"MM-dd HH:mm"):dateFormat(t,"yyyy-MM-dd HH:mm")}}(),transTime2=function(){var e=function(e){e.setMinutes(0),e.setSeconds(0),e.setMilliseconds(0),e.setHours(0);var t=e.getTime();e.setMonth(1),e.setDate(1);var s=e.getTime();return[t,s]};return function(t){"string"==typeof t&&(t=new Date(t).getTime());var s=e(new Date);return t>=s[0]?dateFormat(t,"HH:mm"):t>=s[0]-864e5?"昨天":t>=s[0]-1728e5?"前天":t>=s[0]-6048e5?"星期"+dateFormat(t,"w"):t>=s[1]?dateFormat(t,"M/d"):dateFormat(t,"yy/M/d")}}(),dateFormat=function(){var e={i:!0,r:/\byyyy|yy|MM|cM|eM|M|dd|d|HH|H|mm|ms|ss|m|s|w|ct|et\b/g},t=["上午","下午"],s=["A.M.","P.M."],n=["日","一","二","三","四","五","六"],r=["一","二","三","四","五","六","七","八","九","十","十一","十二"],i=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sept","Oct","Nov","Dec"],a=function(e){return e=parseInt(e)||0,(10>e?"0":"")+e},o=function(e){return 12>e?0:1};return function(u,c,l){if(!u||!c)return"";u=new Date(u),e.yyyy=u.getFullYear(),e.yy=(""+e.yyyy).substr(2),e.M=u.getMonth()+1,e.MM=a(e.M),e.eM=i[e.M-1],e.cM=r[e.M-1],e.d=u.getDate(),e.dd=a(e.d),e.H=u.getHours(),e.HH=a(e.H),e.m=u.getMinutes(),e.mm=a(e.m),e.s=u.getSeconds(),e.ss=a(e.s),e.ms=u.getMilliseconds(),e.w=n[u.getDay()];var d=o(e.H);return e.ct=t[d],e.et=s[d],l&&(e.H=e.H%12),_$encode(e,c)}}(),_$encode=function(e,t){return t=""+t,e&&t?t.replace(e.r,function(t){var s=e[e.i?t:t.toLowerCase()];return null!=s?s:t}):t||""},_$escape=function(){var e=/<br\/?>$/,t={r:/\<|\>|\&|\r|\n|\s|\'|\"/g,"<":"&lt;",">":"&gt;","&":"&amp;"," ":"&nbsp;",'"':"&quot;","'":"&#39;","\n":"<br/>","\r":""};return function(s){return s=_$encode(t,s),s.replace(e,"<br/><br/>")}}();Array.prototype.each=function(e){e=e||Function.K;for(var t=[],s=Array.prototype.slice.call(arguments,1),n=0;this.length>n;n++){var r=e.apply(this,[this[n],n].concat(s));null!=r&&t.push(r)}return t},Array.prototype.contains=function(e){for(var t=0;this.length>t;t++)if(this[t]==e)return!0;return!1},Array.prototype.uniquelize=function(){for(var e=[],t=0;this.length>t;t++)e.contains(this[t])||e.push(this[t]);return e},Array.complement=function(e,t){return Array.minus(Array.union(e,t),Array.intersect(e,t))},Array.intersect=function(e,t){return e.uniquelize().each(function(e){return t.contains(e)?e:null})},Array.minus=function(e,t){return e.uniquelize().each(function(e){return t.contains(e)?null:e})},Array.union=function(e,t){return e.concat(t).uniquelize()};var guid=function(){var e=function(){return(0|65536*(1+Math.random())).toString(16).substring(1)};return e()+e()+"-"+e()+"-"+e()+"-"+e()+"-"+e()+e()+e()};config.baseUrl="http://112.74.210.208:8080/v1/",config.y2wAutorizeUrl="http://console.yun2win.com/";var globalMinDate=new Date(2e3,0,1).getTime(),globalMaxDate=new Date(3e3,0,1).getTime(),globalMinSyncDate=new Date(2e3,0,2).getTime();baseRequest.get=function(e,t,s,n){n||(n=nop),$.ajax({url:config.baseUrl+e,type:"GET",dataType:"json",contentType:"application/x-www-form-urlencoded",beforeSend:function(e){t&&e.setRequestHeader("Client-Sync-Time",t),s&&e.setRequestHeader("Authorization","Bearer "+s)},success:function(e){n(null,e)},error:function(e){return 401==e.status?(alert("您登录的信息已过期,请重新登录!"),y2w.logout(),void 0):(n(e),void 0)}})},baseRequest.post=function(e,t,s,n){n||(n=nop),$.ajax({url:config.baseUrl+e,type:"POST",data:t,dataType:"json",contentType:"application/x-www-form-urlencoded",beforeSend:function(e){s&&e.setRequestHeader("Authorization","Bearer "+s)},success:function(e){n(null,e)},error:function(e){return 401==e.status?(alert("您登录的信息已过期,请重新登录!"),y2w.logout(),void 0):(n(e),void 0)}})},baseRequest.delete=function(e,t,s,n){n||(n=nop),$.ajax({url:config.baseUrl+e,type:"DELETE",data:t,dataType:"json",contentType:"application/x-www-form-urlencoded",beforeSend:function(e){s&&e.setRequestHeader("Authorization","Bearer "+s)},success:function(e){n(null,e)},error:function(e){return 401==e.status?(alert("您登录的信息已过期,请重新登录!"),y2w.logout(),void 0):(n(e),void 0)}})},baseRequest.put=function(e,t,s,n){n||(n=nop),$.ajax({url:config.baseUrl+e,type:"PUT",data:t,dataType:"json",contentType:"application/x-www-form-urlencoded",beforeSend:function(e){s&&e.setRequestHeader("Authorization","Bearer "+s)},success:function(e){n(null,e)},error:function(e){return 401==e.status?(alert("您登录的信息已过期,请重新登录!"),y2w.logout(),void 0):(n(e),void 0)}})},baseRequest.uploadBase64Image=function(e,t,s,n,r){r||(r=nop);var i=Math.random().toString(16),a=new XMLHttpRequest;a.open("POST",config.baseUrl+e),a.setRequestHeader("Authorization","Bearer "+n),a.overrideMimeType("application/octet-stream"),a.setRequestHeader("Content-Type","multipart/form-data; boundary="+i);var o="--"+i+"\r\n";o+="Content-Type: image/jpg\r\n",o+='Content-Disposition: form-data; name="pic"; filename="'+t+'"\r\n',o+="Content-Transfer-Encoding: binary\r\n\r\n";for(var u=transTextToBytes(o),c=transBase64ToBytes(s),l="\r\n--"+i+"--",d=transTextToBytes(l),h=new Uint8Array(u.length+c.length+d.length),p=0;u.length>p;p++)h[p]=u[p];for(var p=0;c.length>p;p++)h[u.length+p]=c[p];for(var p=0;d.length>p;p++)h[u.length+c.length+p]=d[p];a.send(h.buffer),a.onreadystatechange=function(){if(4==a.readyState)if(200==a.status)r(null,JSON.parse(a.responseText));else{if(401==a.status)return alert("您登录的信息已过期,请重新登录!"),y2w.logout(),void 0;r(a.responseText)}}},y2wAuthorizeRequest.post=function(e,t,s,n){n||(n=nop),$.ajax({url:config.y2wAutorizeUrl+e,type:"POST",data:t,dataType:"json",contentType:"application/x-www-form-urlencoded",beforeSend:function(e){s&&e.setRequestHeader("Authorization","Bearer "+s)},success:function(e){n(null,e)},error:function(e){return 400==e.status?(alert("您登录的信息已过期,请重新登录!"),y2w.logout(),void 0):(n(e),void 0)}})};var Users=function(){function e(){var e;this.localStorage=usersLocalStorageSingleton.getInstance(this),this.remote=usersRemoteSingleton.getInstance(this),this.getCurrentUser=function(){if(null==this.localStorage.getCurrentUserId())throw"currentUserId is null, pls relogin!";if(!e){e=this.localStorage.getUsers(this.localStorage.getCurrentUserId());for(var t in e)e[t]=new User(e[t]);var s=this.localStorage.getCurrentUserInfo();s.account=s.account||s.email;var n=new CurrentUser(s);e[n.id]=n,n.init(),this.localStorage.setUsers(e)}return this.get(n.id)},this.get=function(t){return e[t]},this.getUsers=function(){return e},this.create=function(t,s,n,r){if(this.get(t))throw"can not create the user, because the user is exist";var i=new User({id:t,name:s,account:n,avatarUrl:r});return e[i.id]=i,this.localStorage.setUsers(e),i}}var t;return{getInstance:function(){return t||(t=new e),t}}}(),usersLocalStorageSingleton=function(){function e(e){var t=e;this.getCurrentUserId=function(){return localStorage.getItem("y2wIMCurrentUserId")},this.setCurrentUserId=function(e){localStorage.setItem("y2wIMCurrentUserId",e)},this.removeCurrentId=function(){localStorage.removeItem("y2wIMCurrentUserId")},this.getCurrentUserInfo=function(){return JSON.parse(localStorage.getItem(this.getCurrentUserId()))},this.setCurrentUserInfo=function(e){localStorage.setItem(e.id,JSON.stringify(e))},this.removeCurrentUserInfo=function(){delete currentUser.appKey,delete currentUser.secret,delete currentUser.token,delete currentUser.imToken,this.setUsers(t.getUsers()),localStorage.removeItem(currentUser.id)},this.getUsers=function(){var e=localStorage.getItem(this.getCurrentUserId()+"_users");return e?JSON.parse(e):{}},this.setUsers=function(e){localStorage.setItem(this.getCurrentUserId()+"_users",JSON.stringify(e))}}var t;return{getInstance:function(s,n){return t||(t=new e(s,n)),t}}}(),usersRemoteSingleton=function(){function e(e){var t=e;this.register=function(e,t,s,n){n=n||nop;var r="users/register",i={email:e,password:MD5(t),name:s};baseRequest.post(r,i,null,n)},this.login=function(e,s,n){n=n||nop;var r="users/login",i={email:e,password:MD5(s)};baseRequest.post(r,i,null,function(e,s){return e?(n(e),void 0):(t.localStorage.setCurrentUserId(s.id),t.localStorage.setCurrentUserInfo(s),n(null,s),void 0)})},this.search=function(e,s,n){n=n||nop;var r="users?filter_term="+e;baseRequest.get(r,null,currentUser.token,function(e,s){if(e)return n(e),void 0;if(s.total_count){var r=s.entries[0],i=t.get(r.id);i||(i=t.create(r.id,r.name,r.email,r.avatarUrl)),n(null,i)}else n(null,null)})}}var t;return{getInstance:function(s){return t||(t=new e(s)),t}}}(),User=function(e){this.id=e.id,this.name=e.name,this.pinyin=e.pinyin,this.account=e.account||e.email,this.avatarUrl=e.avatarUrl||" ",this.avatarUrl.indexOf("/images/default.jpg")>=0&&(this.avatarUrl=" "),this.role=e.role,this.jobTitle=e.jobTitle,this.phone=e.phone,this.address=e.address,this.status=e.status,this.createdAt=e.createdAt||globalMinDate,this.updatedAt=e.updatedAt||globalMinDate};User.prototype.toJSON=function(){return{id:this.id,name:this.name,pinyin:this.pinyin,account:this.account,avatarUrl:this.avatarUrl,role:this.role,jobTitle:this.jobTitle,phone:this.phone,address:this.address,status:this.status,createdAt:this.createdAt,updatedAt:this.updatedAt}},User.prototype.getAvatarUrl=function(){return this.avatarUrl&&""!=$.trim(this.avatarUrl)&&".."!=$.trim(this.avatarUrl)?config.baseUrl+this.avatarUrl+"?access_token="+currentUser.token:null};var CurrentUser=function(e){User.call(this,e),this.appKey=e.key,this.secret=e.secret,this.token=e.token,this.imToken=e.imToken,this.userConversations=new UserConversations(this),this.contacts=new Contacts(this),this.sessions=new Sessions(this),this.userSessions=new UserSessions(this),this.attchments=new Attachments(this),this.remote=currentUserRemoteSingleton.getInstance(this),this.currentSession,this.y2wIMBridge};CurrentUser.prototype=new User({}),CurrentUser.prototype.init=function(){this.userConversations.init(),this.contacts.init(),this.sessions.init(),this.userSessions.init()},CurrentUser.prototype.logout=function(e){try{this.y2wIMBridge.disconnect()}catch(t){}Users.getInstance().localStorage.removeCurrentUserInfo(),Users.getInstance().localStorage.removeCurrentId(),e()},CurrentUser.prototype.toJSON=function(){return{id:this.id,name:this.name,pinyin:this.pinyin,account:this.account,avatarUrl:this.avatarUrl,role:this.role,jobTitle:this.jobTitle,phone:this.phone,address:this.address,status:this.status,createdAt:this.createdAt,updatedAt:this.updatedAt,key:this.appKey,secret:this.secret,token:this.token,imToken:this.imToken}},CurrentUser.prototype.y2wIMInit=function(){var e=this;this.remote.syncIMToken(function(t){return t?(console.log(t),void 0):(e.y2wIMBridge=new y2wIMBridge(e),void 0)})};var currentUserRemoteSingleton=function(){function e(e){var t=e;this.syncIMToken=function(e){e=e||nop;var s="oauth/token",n={grant_type:"client_credentials",client_id:t.appKey,client_secret:t.secret};y2wAuthorizeRequest.post(s,n,t.token,function(s,n){return s?(e(s),void 0):(t.imToken=n.access_token,e(null,t.imToken),void 0)})},this.store=function(e){e=e||nop;var s="users/"+t.id,n={email:t.account,name:t.name,role:t.role,jobTitle:t.jobTitle,phone:t.phone,address:t.address,status:t.status,avatarUrl:t.avatarUrl};baseRequest.put(s,n,t.token,function(s){return s?(e(s),void 0):(Users.getInstance().localStorage.setCurrentUserInfo(t),Users.getInstance().localStorage.setUsers(Users.getInstance().getUsers()),e(null),void 0)})}}var t;return{getInstance:function(s){return t||(t=new e(s)),t}}}(),UserConversations=function(e){var t,s=new userConversationsLocalStorage(this);this.user=e,this.updatedAt=globalMinDate,this.remote=new userConversationsRemote(this),this.init=function(){t=s.getList(this.user.id+"_userConversations");for(var e in t){var n=this.createUserConversation(t[e]);t[e]=n,this.updatedAt<n.updatedAt&&(this.updatedAt=n.updatedAt)}},this.get=function(e,s){return t[e+"-"+s]},this.createUserConversation=function(e){return new UserConversation(this,e)},this.getUserConversations=function(e){var s=[];for(var n in t)t[n].isDelete||e&&(!e||t[n].type!=e)||s.push(t[n]);return quickSort(s,"updatedAt",!0)},this.addUserConversations=function(e){for(var n=0;e.length>n;n++){var r=this._add(e[n]);this.updatedAt<r.updatedAt&&(this.updatedAt=parseInt(r.updatedAt))}e.length>0&&s.setList(t)},this._add=function(e){var s=t[e.type+"-"+e.targetId];return s?s.update(e):s=this.createUserConversation(e),t[s.type+"-"+s.targetId]=s,s},this.updateCache_List=function(){s.setList(t)}},userConversationsLocalStorage=function(e){this.userConversations=e};userConversationsLocalStorage.prototype.getList=function(){var e=localStorage.getItem(this.userConversations.user.id+"_userConversations");return e?JSON.parse(e):{}},userConversationsLocalStorage.prototype.setList=function(e){localStorage.setItem(this.userConversations.user.id+"_userConversations",JSON.stringify(e))};var userConversationsRemote=function(e){this.userConversations=e};userConversationsRemote.prototype.sync=function(e){e=e||nop;var t=this,s="users/"+t.userConversations.user.id+"/userConversations";baseRequest.get(s,t.userConversations.updatedAt,t.userConversations.user.token,function(s,n){return s?(e(s),void 0):(t.userConversations.addUserConversations(n.entries),e(null,n.entries.length),void 0)})},userConversationsRemote.prototype.store=function(e,t){var s=this;t=t||nop;var n="users/"+s.userConversations.user.id+"/userConversations/"+e.id,r={targetId:e.targetId,name:e.name,type:e.type,avatarUrl:e.avatarUrl};baseRequest.put(n,r,s.userConversations.user.token,function(e,s){return e?(t(e),void 0):(t(null,s),void 0)})},userConversationsRemote.prototype.remove=function(e,t){var s=this;t=t||nop;var n="users/"+s.userConversations.user.id+"/userConversations/"+e;baseRequest.delete(n,null,s.userConversations.user.token,function(e,s){return e?(t(e),void 0):(t(null,s),void 0)})};var UserConversation=function(e,t){if(this.userConversations=e,this.id=t.id,this.name=t.name,this.avatarUrl=t.avatarUrl||" ",this.avatarUrl.indexOf("/images/default.jpg")>=0&&(this.avatarUrl=" "),this.targetId=t.targetId,this.unread=t.unread,this.type=t.type,this.isDelete=t.isDelete,this.createdAt=new Date(t.createdAt).getTime(),this.updatedAt=new Date(t.updatedAt).getTime(),this.visiable=t.visiable,this.top=t.top,"p2p"==this.type){var s=Users.getInstance().get(this.targetId);void 0===s&&Users.getInstance().create(this.targetId,this.name,null,this.avatarUrl)}if(this.firstGetLastMessges=!0,this.lastMessage=t.lastMessage,this.lastMessage){this.lastMessage.scene=this.type;try{this.lastMessage.content=JSON.parse(this.lastMessage.content)}catch(n){}if("p2p"==this.type){var s=Users.getInstance().get(this.targetId);this.lastMessage.sender==this.userConversations.user.id?(this.lastMessage.from=this.userConversations.user,this.lastMessage.to=s):(this.lastMessage.from=s,this.lastMessage.to=this.userConversations.user)}else"group"==this.type&&(this.lastMessage.from=null,this.lastMessage&&this.lastMessage.sender&&(this.lastMessage.from=Users.getInstance().get(this.lastMessage.sender)),this.lastMessage.to=null)}};UserConversation.prototype.update=function(e){if(this.name=e.name,this.avatarUrl=e.avatarUrl||" ",this.avatarUrl.indexOf("/images/default.jpg")>=0&&(this.avatarUrl=" "),this.unread=e.unread,this.isDelete=e.isDelete,this.createdAt=new Date(e.createdAt).getTime(),this.updatedAt=new Date(e.updatedAt).getTime(),this.visiable=e.visiable,this.top=e.top,this.lastMessage=e.lastMessage,this.lastMessage){this.lastMessage.scene=this.type;try{this.lastMessage.content=JSON.parse(this.lastMessage.content)}catch(t){}if("p2p"==this.type){var s=Users.getInstance().get(this.targetId);void 0===s&&(s=Users.getInstance().create(this.targetId,this.name,null,this.avatarUrl)),this.lastMessage.sender==this.userConversations.user.id?(this.lastMessage.from=this.userConversations.user,this.lastMessage.to=s):(this.lastMessage.from=s,this.lastMessage.to=this.userConversations.user)}else"group"==this.type&&(this.lastMessage.from=null,this.lastMessage&&this.lastMessage.sender&&(this.lastMessage.from=Users.getInstance().get(this.lastMessage.sender)),this.lastMessage.to=null)}},UserConversation.prototype.toJSON=function(){var e={id:this.id,name:this.name,avatarUrl:this.avatarUrl,targetId:this.targetId,unread:this.unread,type:this.type,isDelete:this.isDelete,createdAt:this.createdAt,updatedAt:this.updatedAt,visiable:this.visiable,top:this.top,firstGetLastMessges:this.firstGetLastMessges};return this.lastMessage&&(e.lastMessage={scene:this.lastMessage.scene,sender:this.lastMessage.sender,content:this.lastMessage.content,type:this.lastMessage.type}),e},UserConversation.prototype.getName=function(){if("p2p"==this.type){var e=this.userConversations.user.contacts.get(this.targetId);return e?e.getName():Users.getInstance().get(this.targetId).name}return this.name},UserConversation.prototype.getAvatarUrl=function(){if("p2p"==this.type){var e=this.userConversations.user.contacts.get(this.targetId);return e?e.getAvatarUrl():Users.getInstance().get(this.targetId).getAvatarUrl()}return this.avatarUrl&&""!=$.trim(this.avatarUrl)?config.baseUrl+this.avatarUrl+"?access_token="+this.userConversations.user.token:null},UserConversation.prototype.getSession=function(e){this.userConversations.user.sessions.get(this.targetId,this.type,e)},UserConversation.prototype.syncMessages=function(e,t){t||(t=e||nop,e=!1);var s=this;this.getSession(function(n,r){return n?(t(n),void 0):(e||s.updatedAt>r.messages.updatedAt?r.messages.remote.sync(function(e,s){return e?(t(e),void 0):(t(null,s),void 0)}):t(null,[]),void 0)})},UserConversation.prototype.getLastMessages=function(e){e=e||nop;var t=this;this.getSession(function(s,n){return s?(e(s),void 0):(n.messages.remote.getLastMessages(function(s,n){return s?(e(s),void 0):(t.firstGetLastMessges=!1,e(null,n),void 0)}),void 0)})},UserConversation.prototype.clearUnread=function(){this.unread=0,this.userConversations.updateCache_List()};var Contacts=function(e){var t,s=new contactsLocalStorage(this);this.user=e,this.updatedAt=globalMinDate,this.remote=new contactsRemote(this),this.init=function(){t=s.getList();for(var e in t){var n=this.createContact(t[e]);t[e]=n,this.updatedAt<n.updatedAt&&(this.updatedAt=n.updatedAt)}},this.get=function(e){return t[e]},this.createContact=function(e){return new Contact(this,e)},this.getContacts=function(){var e=[];for(var s in t)t[s].isDelete||e.push(t[s]);return e},this.addContacts=function(e){for(var n=0;e.length>n;n++){var r=this._add(e[n]);this.updatedAt<r.updatedAt&&(this.updatedAt=parseInt(r.updatedAt))}e.length>0&&s.setList(t)},this._add=function(e){var s=t[e.userId];return s?s.update(e):s=this.createContact(e),t[s.userId]=s,s}},contactsLocalStorage=function(e){this.contacts=e};contactsLocalStorage.prototype.getList=function(){var e=localStorage.getItem(this.contacts.user.id+"_contacts");return e?JSON.parse(e):{}},contactsLocalStorage.prototype.setList=function(e){localStorage.setItem(this.contacts.user.id+"_contacts",JSON.stringify(e))};var contactsRemote=function(e){this.contacts=e};contactsRemote.prototype.sync=function(e){e=e||nop;var t=this,s="users/"+t.contacts.user.id+"/contacts";baseRequest.get(s,t.contacts.updatedAt,t.contacts.user.token,function(s,n){return s?(e(s),void 0):(t.contacts.addContacts(n.entries),e(null,n.entries.length),void 0)
})},contactsRemote.prototype.add=function(e,t,s){s=s||nop;var n=this,r="users/"+n.contacts.user.id+"/contacts",i={userId:e,name:t};baseRequest.post(r,i,n.contacts.user.token,function(e,t){return e?(s(e),void 0):(s(null,t),void 0)})},contactsRemote.prototype.store=function(e,t){t=t||nop;var s=this,n="users/"+s.contacts.user.id+"/contacts/"+e.id,r={userId:e.userId,name:e.name,title:e.title,remark:e.remark,avatarUrl:e.avatarUrl};baseRequest.put(n,r,s.contacts.user.token,function(e,s){return e?(t(e),void 0):(t(null,s),void 0)})},contactsRemote.prototype.remove=function(e,t){t=t||nop;var s=this,n="users/"+s.contacts.user.id+"/contacts/"+e;baseRequest.delete(n,null,s.contacts.user.token,function(e){return e?(t(e),void 0):(t(),void 0)})};var Contact=function(e,t){this.contacts=e,this.id=t.id,this.name=t.name,this.pinyin=t.pinyin,this.title=t.title,this.titlePinyin=t.titlePinyin,this.remark=t.remark,this.isDelete=t.isDelete,this.createdAt=new Date(t.createdAt).getTime(),this.updatedAt=new Date(t.updatedAt).getTime(),this.userId=t.userId,this.user=Users.getInstance().get(this.userId),void 0===this.user&&(this.user=Users.getInstance().create(t.userId,t.name,t.email,t.avatarUrl)),this.avatarUrl=t.avatarUrl||" "};Contact.prototype.update=function(e){this.name=e.name,this.pinyin=e.pinyin,this.title=e.title,this.titlePinyin=e.titlePinyin,this.remark=e.remark,this.isDelete=e.isDelete,this.createdAt=new Date(e.createdAt).getTime(),this.updatedAt=new Date(e.updatedAt).getTime(),this.avatarUrl=e.avatarUrl||" "},Contact.prototype.toJSON=function(){return{id:this.id,name:this.name,pinyin:this.pinyin,title:this.title,titlePinyin:this.titlePinyin,remark:this.remark,isDelete:this.isDelete,createdAt:this.createdAt,updatedAt:this.updatedAt,userId:this.userId,avatarUrl:this.avatarUrl}},Contact.prototype.getName=function(){return this.title&&this.title.length>0?this.title:this.user.name},Contact.prototype.getPinYin=function(){return this.title&&this.title.length>0?this.titlePinyin:this.pinyin},Contact.prototype.getAvatarUrl=function(){return this.user.getAvatarUrl()};var Messages=function(e){this.session=e,this._list=[],this.more=!0,this.updatedAt=globalMinDate,this.topDate=globalMaxDate,this.sessionUpdatedAt=globalMinDate,this.remote=new messagesRemote(this)};Messages.prototype.count=function(){return this._list.length},Messages.prototype.getMessages=function(){return this._list},Messages.prototype.createMessage=function(e){return new Message(this,e)},Messages.prototype.add=function(e){this._list.push(e)},Messages.prototype.insert=function(e,t){this._list.splice(e,0,t)};var messagesRemote=function(e){this.messages=e};messagesRemote.prototype.store=function(e,t){t=t||nop;var s=this,n="sessions/"+s.messages.session.id+"/messages",r={sender:e.sender,content:JSON.stringify(e.content),type:e.type};baseRequest.post(n,r,s.messages.session.sessions.user.token,function(s,n){return s?(t(s),e.status="storefailed",void 0):(e.id=n.id,e.createdAt=new Date(n.createdAt).getTime(),e.updatedAt=new Date(n.updatedAt).getTime(),e.status="stored",t(null,e),void 0)})},messagesRemote.prototype.sync=function(e){e=e||nop;var t=this,s="sessions/"+t.messages.session.id+"/messages";baseRequest.get(s,t.messages.updatedAt,t.messages.session.sessions.user.token,function(s,n){if(s)if("403"==s.status){var r=t.messages.session.getConversation();t.messages.updatedAt=r.updatedAt;var i=t.messages.session.sessions.getTargetId(t.messages.session.id,t.messages.session.type);t.messages.session.sessions.remote.sync(i,t.messages.session.type,function(t){return t?(e(t),void 0):(e(),void 0)})}else e(s);else{for(var a=t.messages.getMessages(),o=a.length,u=a.length-1;u>=0&&a[u].status;u--)o=u;for(var c=[],u=0;n.entries.length>u;u++){var l=t.messages.createMessage(n.entries[u]);t.messages.insert(o++,l),c.push(l),t.messages.updatedAt<l.updatedAt&&(t.messages.updatedAt=l.updatedAt)}t.messages.updatedAt==globalMinDate&&(t.messages.updatedAt=globalMinSyncDate),a=t.messages.getMessages();for(var u=a.length-1;u>=o;u--)"stored"==a[u].status&&a.splice(u,1);if(t.messages.session.updatedAt<new Date(n.sessionUpdatedAt).getTime()){var i=t.messages.session.sessions.getTargetId(t.messages.session.id,t.messages.session.type);t.messages.session.sessions.remote.sync(i,t.messages.session.type,function(t){return t?(e(t),void 0):(e(null,c),void 0)})}else e(null,c)}})},messagesRemote.prototype.getLastMessages=function(e){e=e||nop;var t=this,s=20,n="sessions/"+t.messages.session.id+"/messages/history?limit="+s;baseRequest.get(n,t.messages.topDate,t.messages.session.sessions.user.token,function(n,r){if(n)return e(n),void 0;for(var i=[],a=0;r.length>a;a++){var o=t.messages.createMessage(r[a]);t.messages.insert(0,o),i.splice(0,0,o),t.messages.updatedAt<o.updatedAt&&(t.messages.updatedAt=o.updatedAt),t.messages.topDate>o.updatedAt&&(t.messages.topDate=o.updatedAt)}t.messages.updatedAt==globalMinDate&&(t.messages.updatedAt=globalMinSyncDate),t.messages.more=s>r.length?!1:!0,e(null,i)})};var Message=function(e,t){if(this.messages=e,this.id=t.id||guid(),this.sender=t.sender,this.from,this.to,"p2p"==this.messages.session.type){var s=this.messages.session.members.getMember(this.sender);s&&(this.from=s.user),this.from&&(s=this.messages.session.members.getP2POtherSideMember(this.from.id),s&&(this.to=s.user))}else"group"==this.messages.session.type&&(this.from=this.messages.session.members.getMember(this.sender),this.to=this.messages.session);this.type=t.type;try{this.content=JSON.parse(t.content)}catch(n){this.content=t.content}this.createdAt=t.createdAt?new Date(t.createdAt).getTime():globalMinDate,this.updatedAt=t.updatedAt?new Date(t.updatedAt).getTime():globalMinDate,this.isDelete=t.isDelete,this.status=t.status||""},UserSessions=function(e){var t,s=new userSessionsLocalStorage(this);this.user=e,this.updatedAt=globalMinDate,this.remote=new userSessionsRemote(this),this.init=function(){t=s.getList();for(var e in t){var n=this.createUserSession(t[e]);t[e]=n,this.updatedAt<n.updatedAt&&(this.updatedAt=n.updatedAt)}},this.get=function(e){return t[e]},this.createUserSession=function(e){return new UserSession(this,e)},this.getUserSessions=function(){var e=[];for(var s in t)t[s].isDelete||e.push(t[s]);return e},this.addUserSessions=function(e){for(var n=0;e.length>n;n++){var r=this._add(e[n]);this.updatedAt<r.updatedAt&&(this.updatedAt=parseInt(r.updatedAt))}e.length>0&&s.setList(t)},this._add=function(e){var s=t[e.sessionId];return s?s.update(e):s=this.createUserSession(e),t[s.sessionId]=s,s}},userSessionsLocalStorage=function(e){this.userSessions=e};userSessionsLocalStorage.prototype.getList=function(){var e=localStorage.getItem(this.userSessions.user.id+"_userSessions");return e?JSON.parse(e):{}},userSessionsLocalStorage.prototype.setList=function(e){localStorage.setItem(this.userSessions.user.id+"_userSessions",JSON.stringify(e))};var userSessionsRemote=function(e){this.userSessions=e};userSessionsRemote.prototype.add=function(e,t,s,n){var r=this;n=n||nop;var i="users/"+r.userSessions.user.id+"/userSessions",a={sessionId:e,name:t,avatarUrl:s};baseRequest.post(i,a,r.userSessions.user.token,function(e,t){return e?(n(e),void 0):(n(null,t),void 0)})},userSessionsRemote.prototype.remove=function(e,t){var s=this;t=t||nop;var n="users/"+s.userSessions.user.id+"/userSessions/"+e,r={};baseRequest.delete(n,r,s.userSessions.user.token,function(e){return e?(t(e),void 0):(t(null),void 0)})},userSessionsRemote.prototype.sync=function(e){e=e||nop;var t=this,s="users/"+t.userSessions.user.id+"/userSessions";baseRequest.get(s,t.userSessions.updatedAt,t.userSessions.user.token,function(s,n){return s?(e(s),void 0):(t.userSessions.addUserSessions(n.entries),e(null,n.entries.length),void 0)})};var UserSession=function(e,t){this.userSessions=e,this.id=t.id,this.sessionId=t.sessionId,this.name=t.name,this.isDelete=t.isDelete,this.createdAt=new Date(t.createdAt).getTime(),this.updatedAt=new Date(t.updatedAt).getTime(),this.avatarUrl=t.avatarUrl||" ",this.avatarUrl&&this.avatarUrl.indexOf("/images/default.jpg")>=0&&(this.avatarUrl=" ")};UserSession.prototype.update=function(e){this.name=e.name,this.isDelete=e.isDelete,this.createdAt=new Date(e.createdAt).getTime(),this.updatedAt=new Date(e.updatedAt).getTime(),this.avatarUrl=e.avatarUrl||" ",this.avatarUrl&&this.avatarUrl.indexOf("/images/default.jpg")>=0&&(this.avatarUrl=" ")},UserSession.prototype.toJSON=function(){return{id:this.id,sessionId:this.sessionId,name:this.name,isDelete:this.isDelete,createdAt:this.createdAt,updatedAt:this.updatedAt,avatarUrl:this.avatarUrl}},UserSession.prototype.getAvatarUrl=function(){return this.avatarUrl&&""!=$.trim(this.avatarUrl)?config.baseUrl+this.avatarUrl+"?access_token="+this.userSessions.user.token:null};var SessionMembers=function(e){var t,s=new sessionMembersLocalStorage(this);this.session=e,this.createdAt=globalMinDate,this.updatedAt=globalMinDate,this.init=function(){t=s.getList();for(var e in t){var n=this.createSessionMember(t[e]);t[e]=n,this.createdAt<n.createdAt&&(this.createdAt=n.createdAt),this.updatedAt<n.updatedAt&&(this.updatedAt=n.updatedAt)}},this.remove=function(e){delete t[e],s.setList(t)},this.addSessionMembers=function(e){for(var n=0;e.length>n;n++){var r=this._add(e[n]);this.createdAt<r.createdAt&&(this.createdAt=r.createdAt),this.updatedAt<r.updatedAt&&(this.updatedAt=r.updatedAt)}e.length>0&&s.setList(t)},this._add=function(e){var s=t[e.userId];return s?s.update(e):s=this.createSessionMember(e),t[s.userId]=s,s},this.createSessionMember=function(e){return new SessionMember(this,e)},this.getMember=function(e){return t[e]},this.getMembers=function(){var e=[];for(var s in t)t[s].isDelete||e.push(t[s]);return e},this.getP2POtherSideMember=function(e){for(var s in t)if(s!=e)return t[s];return null},this.remote=new sessionMembersRemote(this),this.init()},sessionMembersLocalStorage=function(e){this.sessionMembers=e};sessionMembersLocalStorage.prototype.getList=function(){var e=localStorage.getItem(this.sessionMembers.session.sessions.user.id+"_"+this.sessionMembers.session.id+"_sessionMembers");return e?JSON.parse(e):{}},sessionMembersLocalStorage.prototype.setList=function(e){localStorage.setItem(this.sessionMembers.session.sessions.user.id+"_"+this.sessionMembers.session.id+"_sessionMembers",JSON.stringify(e))};var sessionMembersRemote=function(e){this.sessionMembers=e};sessionMembersRemote.prototype.sync=function(e){e=e||nop;var t=this,s="sessions/"+t.sessionMembers.session.id+"/members";baseRequest.get(s,t.sessionMembers.updatedAt,t.sessionMembers.session.sessions.user.token,function(s,n){return s?(e(s),void 0):(t.sessionMembers.addSessionMembers(n.entries),e(),void 0)})},sessionMembersRemote.prototype.add=function(e,t,s,n,r,i){var a=this;i=i||nop;var o="sessions/"+a.sessionMembers.session.id+"/members",u={userId:e,name:t,role:s,avatarUrl:n,status:r};baseRequest.post(o,u,a.sessionMembers.session.sessions.user.token,function(e,t){return e?(i(e),void 0):(i(null,t),void 0)})},sessionMembersRemote.prototype.remove=function(e,t){var s=this;t=t||nop;var n="sessions/"+s.sessionMembers.session.id+"/members/"+e;baseRequest.delete(n,null,s.sessionMembers.session.sessions.user.token,function(e){return e?(t(e),void 0):(t(null),void 0)})};var SessionMember=function(e,t){this.sessionMembers=e,this.id=t.id,this.name=t.name,this.pinyin=t.pinyin,this.createdAt=new Date(t.createdAt).getTime(),this.updatedAt=new Date(t.updatedAt).getTime(),this.userId=t.userId,this.isDelete=t.isDelete,this.role=t.role,this.status=t.status,this.user=Users.getInstance().get(this.userId),!this.user&&this.userId&&this.userId.length&&(this.user=Users.getInstance().create(t.userId,t.name,t.email,t.avatarUrl))};SessionMember.prototype.update=function(e){this.name=e.name,this.pinyin=e.pinyin,this.createdAt=new Date(e.createdAt).getTime(),this.updatedAt=new Date(e.updatedAt).getTime(),this.isDelete=e.isDelete,this.role=e.role,this.status=e.status},SessionMember.prototype.toJSON=function(){return{id:this.id,name:this.name,pinyin:this.pinyin,createdAt:this.createdAt,updatedAt:this.updatedAt,userId:this.userId,isDelete:this.isDelete,role:this.role,status:this.status}},SessionMember.prototype.getAvatarUrl=function(){return this.user.getAvatarUrl()};var Sessions=function(e){this.user=e;var t,s,n=new sessionsLocalStorage(this);this.remote=new sessionsRemote(this),this.init=function(){t=n.getList(),s={};for(var e in t){var r=this.createSession(t[e]);t[e]=r,s[r.id]=r}},this.createSession=function(e){return new Session(this,e)},this.get=function(e,s,n){var r=this;return n=n||nop,"p2p"!=s&&"group"!=s&&"single"!=s?(n("session type is invalid"),void 0):t[s+"-"+e]?(n(null,t[s+"-"+e]),void 0):(this.remote.sync(e,s,function(i){if(i)return n(i),void 0;var a=t[s+"-"+e];a?n(null,a):"single"==s?r.remote.add("single",r.user.name,"private",r.user.avatarUrl,function(e,t){return e?(n(e),void 0):(r.add(r.user.id,t),n(null,t),void 0)}):n()}),void 0)},this.getById=function(e){return s[e]},this.getTargetId=function(e,s){for(var n in t)if(t[n].id==e&&t[n].type==s)return n.replace(s+"-","");throw"targetId is not exist"},this.add=function(e,r){var i=t[r.type+"-"+e];return i?i.update(r):i=this.createSession(r),t[r.type+"-"+e]=i,s[i.id]=i,n.setList(t),i},this.remove=function(e){var r=this.getTargetId(e.id,e.type);delete t[e.type+"-"+r],delete s[e.id],n.setList(t)}},sessionsLocalStorage=function(e){this.sessions=e};sessionsLocalStorage.prototype.getList=function(){var e=localStorage.getItem(this.sessions.user.id+"_sessions");return e?JSON.parse(e):{}},sessionsLocalStorage.prototype.setList=function(e){localStorage.setItem(this.sessions.user.id+"_sessions",JSON.stringify(e))};var sessionsRemote=function(e){this.sessions=e};sessionsRemote.prototype.sync=function(e,t,s){var n=this;if(s=s||nop,"p2p"!=t&&"group"!=t&&"single"!=t)return s("session type is invalid"),void 0;var r;r="p2p"==t?"sessions/p2p/"+n.sessions.user.id+"/"+e:"group"==t?"sessions/"+e:"sessions/p2p/"+n.sessions.user.id+"/"+e,baseRequest.get(r,null,n.sessions.user.token,function(t,r){if(t)return s(t),void 0;var i=n.sessions.add(e,r);i.members.remote.sync(function(e){return e?(s(e),void 0):(s(null,i),void 0)})})},sessionsRemote.prototype.add=function(e,t,s,n,r){var i=this;r=r||nop;var a="sessions",o={type:e,name:t,secureType:s,avatarUrl:n};baseRequest.post(a,o,i.sessions.user.token,function(e,t){if(e)return r(e),void 0;var s=i.sessions.createSession(t);r(null,s)})},sessionsRemote.prototype.store=function(e,t){var s=this,n=this.sessions.getTargetId(e.id,e.type);t=t||nop;var r="sessions/"+e.id,i={name:e.name,secureType:e.secureType,avatarUrl:e.avatarUrl};baseRequest.put(r,i,s.sessions.user.token,function(e,r){if(e)return t(e),void 0;var i=s.sessions.add(n,r);i.members.remote.sync(function(e){return e?(t(e),void 0):(t(null,i),void 0)})})};var Session=function(e,t){this.sessions=e,this.id=t.id,this.name=t.name,this.nameChanged=t.nameChanged,this.secureType=t.secureType,this.type=t.type,this.description=t.description,this.avatarUrl=t.avatarUrl||" ",this.createdAt=new Date(t.createdAt).getTime(),this.updatedAt=new Date(t.updatedAt).getTime(),this.members=new SessionMembers(this),this.messages=new Messages(this)};Session.prototype.update=function(e){this.name=e.name,this.nameChanged=e.nameChanged,this.secureType=e.secureType,this.type=e.type,this.description=e.description,this.avatarUrl=e.avatarUrl||" ",this.createdAt=new Date(e.createdAt).getTime(),this.updatedAt=new Date(e.updatedAt).getTime()},Session.prototype.toJSON=function(){return{id:this.id,name:this.name,nameChanged:this.nameChanged,secureType:this.secureType,type:this.type,description:this.description,avatarUrl:this.avatarUrl,createdAt:this.createdAt,updatedAt:this.updatedAt}},Session.prototype.getConversation=function(){if("p2p"==this.type){var e=this.members.getP2POtherSideMember(this.sessions.user.id);return this.sessions.user.userConversations.get(this.type,e.user.id)}return"group"==this.type?this.sessions.user.userConversations.get(this.type,this.id):null};